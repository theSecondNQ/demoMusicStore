<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${music.title} + ' - éŸ³ä¹è¯¦æƒ…'">éŸ³ä¹è¯¦æƒ…</title>
    <link th:href="@{/css/ios-style.css}" rel="stylesheet">
    <style>
        .music-header {
            position: relative;
            height: 200px;
            background: linear-gradient(135deg, var(--ios-purple), var(--ios-blue));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .music-header-content {
            text-align: center;
            z-index: 2;
        }

        .music-cover {
            width: 120px;
            height: 120px;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 36px;
            margin: 0 auto 16px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
        }

        .music-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .music-artist {
            font-size: 16px;
            opacity: 0.9;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .info-card {
            background: var(--ios-gray-6);
            border-radius: 12px;
            padding: 16px;
            text-align: center;
        }

        .info-label {
            font-size: 14px;
            color: var(--ios-gray-1);
            margin-bottom: 8px;
        }

        .info-value {
            font-size: 18px;
            font-weight: 600;
        }

        .action-buttons {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        .price-tag {
            background: var(--ios-green);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 18px;
        }

        .admin-actions {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--ios-gray-5);
        }
        /* æ–°å¢æ’­æ”¾å™¨æ ·å¼ */
        .player {
            background: var(--ios-gray-6);
            border-radius: 12px;
            padding: 16px;
            margin-top: 20px;
        }
        .player-controls {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        .hint { color: var(--ios-gray-2); font-size: 14px; margin-top: 8px; }
        .error-hint { color: var(--ios-red); font-size: 14px; margin-top: 8px; }
    </style>
</head>
<body>
<!-- iOSé£æ ¼å¤´éƒ¨ -->
<header class="ios-header">
    <div class="ios-navbar">
        <a th:href="@{/music/list}" class="ios-brand">
            éŸ³ä¹å•†åº—
        </a>
        <div class="ios-nav-items">
            <a th:href="@{/music/list}" class="ios-btn ios-btn-sm ios-btn-outline" style="color: white; border-color: white;">è¿”å›åˆ—è¡¨</a>
            <div th:if="${session.user}">
                <a th:href="@{/playlist/list}" class="ios-btn ios-btn-sm ios-btn-outline" style="color: white; border-color: white;">æˆ‘çš„æ­Œå•</a>
                <span style="color: white; margin-right: 12px;" th:text="${session.user.username}"></span>
                <a th:href="@{/logout}" class="ios-btn ios-btn-sm ios-btn-danger">é€€å‡º</a>
            </div>
            <div th:unless="${session.user}">
                <a th:href="@{/login}" class="ios-btn ios-btn-sm ios-btn-outline" style="color: white; border-color: white;">ç™»å½•</a>
            </div>
        </div>
    </div>
</header>

<div class="ios-container ios-fade-in">
    <!-- éŸ³ä¹å¤´éƒ¨ä¿¡æ¯ -->
    <div class="music-header">
        <div class="music-header-content">
            <div class="music-cover">
                    <span th:with="titleAbbr=${music.title != null ? (music.title.length() >= 2 ? music.title.substring(0, 2) : music.title) : 'éŸ³ä¹'}">
                        <span th:text="${titleAbbr}"></span>
                    </span>
            </div>
            <h1 class="music-title" th:text="${music.title}"></h1>
            <p class="music-artist" th:text="${music.artist}"></p>
        </div>
    </div>

    <div class="ios-card">
        <div style="padding: 20px;">
            <!-- éŸ³ä¹åŸºæœ¬ä¿¡æ¯ -->
            <div class="info-grid">
                <div class="info-card">
                    <div class="info-label">ğŸ¤ æ­Œæ‰‹</div>
                    <div class="info-value" th:text="${music.artist}"></div>
                </div>
                <div class="info-card">
            <div class="info-label">ä¸“è¾‘</div>
                    <div class="info-value" th:text="${music.album}"></div>
                </div>
                <div class="info-card">
                    <div class="info-label">ğŸ“š åˆ†ç±»</div>
                    <div class="info-value" th:text="${music.categoryName}"></div>
                </div>
                <div class="info-card">
            <div class="info-label">æ—¶é•¿</div>
                    <div class="info-value">
                        <span th:text="${#numbers.formatInteger(music.duration/60, 1)}"></span>åˆ†
                        <span th:text="${#numbers.formatInteger(music.duration%60, 2)}"></span>ç§’
                    </div>
                </div>
                <div class="info-card">
            <div class="info-label">æ’­æ”¾é‡</div>
                    <div class="info-value" th:text="${music.playCount}"></div>
                </div>
                <div class="info-card">
                    <div class="info-label">ğŸ’° ä»·æ ¼</div>
                    <div class="price-tag">ï¿¥<span th:text="${#numbers.formatDecimal(music.price, 1, 2)}"></span></div>
                </div>
            </div>

            <!-- æ’­æ”¾å™¨ä¸æ“ä½œ -->
            <div class="player">
                <div class="player-controls">
                    <audio id="audioPlayer" controls preload="none" style="width: 100%;"></audio>
                </div>
                <div class="hint">
                    <span>é»˜è®¤æä¾›30ç§’è¯•å¬ï¼›å·²è´­ä¹°ç”¨æˆ·å¯æ’­æ”¾æ•´æ›²ã€‚</span>
                </div>
                <div class="error-hint" id="errorHint" style="display:none;">æ’­æ”¾å—é™æˆ–èµ„æºä¸å¯ç”¨ã€‚</div>

                <div class="action-buttons" style="margin-top: 12px;">
            <button class="ios-btn ios-btn-primary" id="btnPreview">è¯•å¬</button>
            <button class="ios-btn ios-btn-success" id="btnStream" th:if="${session.user != null}">æ’­æ”¾æ•´æ›²</button>
                    <span class="hint" th:if="${session.user != null and !purchased and !hasTrialLeft}">ä»Šæ—¥è¯•ç”¨å·²ç”¨å®Œï¼Œè¯·è´­ä¹°åæ’­æ”¾æ•´æ›²ã€‚</span>
                    <span class="hint" th:if="${session.user != null and !purchased and hasTrialLeft}">ä½ ä»Šå¤©è¿˜æœ‰ä¸€æ¬¡æ•´æ›²è¯•ç”¨æœºä¼šã€‚</span>
                    <span class="hint" th:if="${session.user != null and purchased}">å·²è´­ä¹°ï¼Œå¯æ’­æ”¾æ•´æ›²ã€‚</span>
                    <span class="hint" th:if="${session.user == null}">è¯·å…ˆç™»å½•ä»¥æ’­æ”¾æ•´æ›²ã€‚</span>
                </div>
            </div>

            <!-- ç”¨æˆ·æ“ä½œåŒºåŸŸï¼ˆæ”¶è—/è´­ç‰©è½¦/ç®¡ç†å‘˜ï¼‰ -->
            <div th:if="${session.user}">
                <div class="action-buttons">
                    <!-- æ”¶è—/å–æ¶ˆæ”¶è— -->
                    <div th:if="${isFavourite}">
                        <form th:action="@{'/favourite/remove/' + ${music.id}}" method="post" style="display: inline;">
                            <button type="submit" class="ios-btn ios-btn-danger">
            å–æ¶ˆæ”¶è—
                            </button>
                        </form>
                    </div>
                    <div th:unless="${isFavourite}">
                        <form th:action="@{'/favourite/add/' + ${music.id}}" method="post" style="display: inline;">
                            <button type="submit" class="ios-btn ios-btn-primary">
                                <span style="margin-right: 6px;">ğŸ¤</span> æ”¶è—éŸ³ä¹
                            </button>
                        </form>
                    </div>

                    <!-- åŠ å…¥è´­ç‰©è½¦ -->
                    <form th:action="@{/cart/add}" method="post" style="display: inline;">
                        <input type="hidden" name="musicId" th:value="${music.id}">
                        <div style="display: flex; gap: 8px; align-items: center;">
                            <input type="number" name="quantity" value="1" min="1"
                                   style="width: 60px; padding: 8px; border: 1px solid var(--ios-gray-4); border-radius: 8px;">
                            <button type="submit" class="ios-btn ios-btn-success">
            åŠ å…¥è´­ç‰©è½¦
                            </button>
                        </div>
                    </form>
                </div>

                <!-- åŠ å…¥åˆ°æ­Œå•å…¥å£ -->
                <div class="action-buttons">
                    <form th:if="${playlists != null and !#lists.isEmpty(playlists)}" th:action="@{/playlist/addTrack}" method="post" style="display:inline-flex; gap:8px; align-items:center;">
                        <input type="hidden" name="musicId" th:value="${music.id}">
                        <label>åŠ å…¥åˆ°æ­Œå•ï¼š
                            <select name="playlistId">
                                <option th:each="p : ${playlists}" th:value="${p.id}" th:text="${p.name}"></option>
                            </select>
                        </label>
                        <button class="ios-btn ios-btn-primary" type="submit">åŠ å…¥</button>
                    </form>
                    <div th:if="${playlists == null or #lists.isEmpty(playlists)}" class="hint">
                        å°šæ— æ­Œå•ï¼Œå» <a th:href="@{/playlist/create}" class="ios-btn ios-btn-outline">æ–°å»ºæ­Œå•</a>
                    </div>
                </div>

                <!-- ç®¡ç†å‘˜æ“ä½œ -->
                <div th:if="${session.user.role == 'admin'}" class="admin-actions">
                    <h3 style="margin-bottom: 16px;">ğŸ”§ ç®¡ç†å‘˜æ“ä½œ</h3>
                    <div style="display: flex; gap: 12px;">
                        <a th:href="@{'/music/edit/' + ${music.id}}" class="ios-btn ios-btn-warning">
            ç¼–è¾‘éŸ³ä¹
                        </a>
                        <a th:href="@{'/music/delete/' + ${music.id}}" class="ios-btn ios-btn-danger js-delete"
                           th:attr="data-delete-url=@{'/music/delete/' + ${music.id}}">
            åˆ é™¤éŸ³ä¹
                        </a>
                    </div>
                </div>
            </div>

            <!-- æœªç™»å½•æç¤º -->
            <div th:if="${session.user == null}" style="text-align: center; padding: 40px; color: var(--ios-gray-2);">
                <div style="font-size: 48px; margin-bottom: 16px;">ğŸ”’</div>
                <h3>è¯·ç™»å½•åæ“ä½œ</h3>
                <p>è¯· <a th:href="@{/login}" class="ios-btn ios-btn-primary" style="margin-top: 16px;">ç™»å½•</a> åæ”¶è—æˆ–è´­ä¹°éŸ³ä¹ã€‚</p>
            </div>
        </div>
    </div>
</div>

<script th:inline="javascript">
    const audio = document.getElementById('audioPlayer');
    const btnPreview = document.getElementById('btnPreview');
    const btnStream = document.getElementById('btnStream');
    const errorHint = document.getElementById('errorHint');
    const musicId = /*[[${music.id}]]*/ 0;

    function setAudio(src) {
        audio.src = src;
        audio.play().catch(err => {
            errorHint.style.display = 'block';
            errorHint.textContent = 'æ— æ³•æ’­æ”¾éŸ³é¢‘ï¼š' + err;
        });
    }

    if (btnPreview) {
        btnPreview.addEventListener('click', function () {
            errorHint.style.display = 'none';
            setAudio('/music/preview/' + musicId);
        });
    }

    if (btnStream) {
        btnStream.addEventListener('click', function () {
            errorHint.style.display = 'none';
            setAudio('/music/stream/' + musicId);
        });
    }
</script>

<script th:inline="javascript">
    /*<![CDATA[*/
    document.addEventListener('DOMContentLoaded', function(){
        function handleDeleteClick(e){
            e.preventDefault();
            var link = e.currentTarget;
            var url = link.getAttribute('data-delete-url') || link.getAttribute('href');
            if (!url) return;
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™é¦–éŸ³ä¹å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')) return;
            fetch(url, { method: 'GET', credentials: 'same-origin' })
                .then(function(resp){
                    var target = resp && resp.url ? resp.url : '/music/list?msg=' + encodeURIComponent('åˆ é™¤æˆåŠŸ');
                    window.location.href = target;
                })
                .catch(function(){
                    window.location.href = '/music/list?error=' + encodeURIComponent('åˆ é™¤å¤±è´¥ï¼Œè¯·ç¨åå†è¯•');
                });
        }
        document.querySelectorAll('a.js-delete').forEach(function(a){
            a.addEventListener('click', handleDeleteClick);
        });
    });
    /*]]>*/
</script>

<!-- iOSé£æ ¼é¡µè„š -->
<footer style="background: var(--blur-bg); backdrop-filter: blur(20px); padding: 20px; margin-top: 40px; border-top: 1px solid rgba(255, 255, 255, 0.2);">
    <div style="max-width: 1200px; margin: 0 auto; text-align: center; color: white;">
        <div th:if="${siteInfo}">
            <h4 th:text="${siteInfo.siteName}" style="margin-bottom: 8px;"></h4>
            <p style="margin-bottom: 8px;">
                    <span th:if="${siteInfo.customerServicePhone}">
                        å®¢æœç”µè¯ï¼š<span th:text="${siteInfo.customerServicePhone}"></span> Â·
                    </span>
                <span th:if="${siteInfo.email}">
                        é‚®ç®±ï¼š<span th:text="${siteInfo.email}"></span>
                    </span>
            </p>
            <p th:if="${siteInfo.copyright}" th:text="${siteInfo.copyright}"></p>
        </div>
        <div th:unless="${siteInfo}">
            <p>Â© 2025 éŸ³ä¹å•†åº— ç‰ˆæƒæ‰€æœ‰</p>
        </div>
    </div>
</footer>
</body>
</html>